<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sender Page</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link rel="stylesheet" href="/static/style-editor.css">
    <script>
        var socket = io();
        var quill;
        var hasUploadedSingleVideo = false; // Track if current upload contains exactly one video
        var currentVideoIndex = 0;
        var selectedAnimation = 'fade';

        document.addEventListener("DOMContentLoaded", function () {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'color': [] }, 'bold', 'italic', 'underline'],
                        [{ 'align': '' }, { 'align': 'center' }, { 'align': 'right' }]
                    ]
                },
            });

            quill.clipboard.dangerouslyPasteHTML('<p class="ql-align-center"><br></p>');

            quill.on('text-change', function () {
                updateCharacterCount();
            });

            updateCharacterCount();

            document.addEventListener("keydown", function (event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    sendText();
                }
            });

            setupSelectableButtons();
            setupDragAndDrop();
        });

        socket.on("connect", function () {
            console.log("Connected to WebSocket");
        });

        socket.on("disconnect", function () {
            console.log("Disconnected. Attempting to reconnect...");
            setTimeout(() => {
                socket.connect();
            }, 3000);
        });

        socket.on("autoplay_blocked", function () {
            var statusIndicator = document.getElementById("statusIndicator");
            statusIndicator.textContent = "‚ùå Autoplay blocked. Interaction with the other page is needed.";
            setTimeout(() => statusIndicator.textContent = "", 3000);
        });

        function setupSelectableButtons() {
            const buttons = document.querySelectorAll('.selectable-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    buttons.forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');
                    selectedAnimation = button.textContent.trim().toLowerCase() === 'scroll' ? 'scroll' : 'fade';
                });
            });
        }

        function sendText() {
            var statusIndicator = document.getElementById("statusIndicator");
            var message = quill.root.innerHTML;
            console.log(`Sending text: ${message}`);
            var alignment = 'left';

            if (quill.root.firstChild.classList.contains('ql-align-center')) {
                alignment = 'center';
            } else if (quill.root.firstChild.classList.contains('ql-align-right')) {
                alignment = 'right';
            } else if (quill.root.firstChild.classList.contains('ql-align-left')) {
                alignment = 'left';
            }

            message = message.replace(/<p><br><\/p>/g, "<br>").trim();

            if (message.length > 0 && message.length <= 2000) {
                statusIndicator.textContent = "üü° Sending...";
                socket.emit("send_text", { "message": message, "align": alignment, "animation": selectedAnimation }, function () {
                    statusIndicator.textContent = "‚úÖ Sent!";
                    setTimeout(() => statusIndicator.textContent = "", 3000);
                });
                quill.root.innerHTML = '<p class="ql-align-center"><br></p>';
                updateCharacterCount();
            }
        }

        function setupDragAndDrop() {
            const dragDropZone = document.getElementById('dragDropZone');
            const fileInput = document.getElementById('fileInput');
            let dragCounter = 0;

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            // Show/hide drop zone when files are dragged over document
            document.addEventListener('dragenter', function (e) {
                // Only react if dragging files (not text or other elements)
                if (hasFiles(e)) {
                    dragCounter++;
                    dragDropZone.classList.add('active');
                }
            });

            document.addEventListener('dragleave', function (e) {
                // Only react if leaving the window (not child elements)
                if (e.clientX === 0 || e.clientY === 0 ||
                    e.clientX >= (window.innerWidth || document.documentElement.clientWidth) ||
                    e.clientY >= (window.innerHeight || document.documentElement.clientHeight)) {
                    dragCounter = 0;
                    dragDropZone.classList.remove('active');
                }
            });

            document.addEventListener('drop', function (e) {
                dragCounter = 0;
                dragDropZone.classList.remove('active');

                if (hasFiles(e)) {
                    const dt = e.dataTransfer;
                    const files = dt.files;

                    if (files.length) {
                        // Clear previous files and add new ones
                        fileInput.files = files;
                        uploadFiles();
                    }
                }
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function hasFiles(event) {
                if (event.dataTransfer.types) {
                    for (let i = 0; i < event.dataTransfer.types.length; i++) {
                        if (event.dataTransfer.types[i] === 'Files') {
                            return true;
                        }
                    }
                }
                return false;
            }
        }

        function uploadFiles() {
            var fileInput = document.getElementById("fileInput");
            var statusIndicator = document.getElementById("statusIndicator");
            var videoControls = document.getElementById("videoControls");

            var files = fileInput.files;
            if (!files || files.length === 0) {
                console.log("No files selected for upload.");
                statusIndicator.textContent = "‚ùå No files selected.";
                return;
            }

            var allowedImageTypes = ["image/png", "image/jpeg", "image/jpg", "image/gif"];
            var allowedVideoTypes = ["video/mp4", "video/mov", "video/avi", "video/mkv", "video/quicktime"];
            var videoCount = 0;
            var fileCount = fileInput.files.length;

            var formData = new FormData();
            Array.from(fileInput.files).forEach((file, index) => {
                console.log(`Uploading file: ${file.name}, Type: ${file.type}`);
                if (!allowedImageTypes.includes(file.type) && !allowedVideoTypes.includes(file.type)) {
                    console.log(`Invalid file type: ${file.name}`);
                    statusIndicator.textContent = `‚ùå Invalid file type: ${file.name}. Only images and videos are allowed.`;
                } else {
                    formData.append("files[]", file);
                    if (allowedVideoTypes.includes(file.type)) {
                        videoCount++;
                    }
                }
            });

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/upload", true);

            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    let percentComplete = Math.round((event.loaded / event.total) * 100);
                    statusIndicator.textContent = `üü° Uploading... ${percentComplete}%`;
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    statusIndicator.textContent = "‚úÖ All files uploaded!";
                    // Show video controls only if exactly one video was uploaded
                    hasUploadedSingleVideo = (videoCount === 1 && fileCount === 1);
                    videoControls.style.display = hasUploadedSingleVideo ? "flex" : "none";
                    currentVideoIndex = 0; // Reset to first video when new upload occurs
                } else {
                    statusIndicator.textContent = "‚ùå Upload failed.";
                    videoControls.style.display = "none";
                    hasUploadedSingleVideo = false;
                }
                setTimeout(() => (statusIndicator.textContent = ""), 3000);
            };

            xhr.onerror = function () {
                statusIndicator.textContent = "‚ùå Upload failed.";
                videoControls.style.display = "none";
                hasUploadedSingleVideo = false;
            };

            xhr.send(formData);
            fileInput.value = "";
        }

        function controlVideo(action) {
            if (!hasUploadedSingleVideo) {
                alert("No single video uploaded yet!");
                return;
            }

            console.log(`Sending ${action} for video at index ${currentVideoIndex}`);
            socket.emit("video_control", {
                action: action,
                index: currentVideoIndex
            });
        }

        function playVideo() { controlVideo("play"); }
        function pauseVideo() { controlVideo("pause"); }
        function muteVideo() { controlVideo("mute"); }
        function unmuteVideo() { controlVideo("unmute"); }

        function updateCharacterCount() {
            var charCount = document.getElementById("charCount");
            var sendButton = document.getElementById("sendTextBtn");
            var statusIndicator = document.getElementById("statusIndicator");

            var text = quill.getText().trim();
            var lines = text.split("\n");
            var currentLength = text.length;

            charCount.textContent = currentLength + " / 2000 characters";

            if (lines.length > 20) {
                statusIndicator.textContent = "‚ùå Cannot go over the 20 Line limit.";
                sendButton.disabled = true;
            } else if (currentLength > 2000) {
                statusIndicator.textContent = "‚ùå Cannot go over the 2000 Character limit.";
                sendButton.disabled = true;
            } else {
                statusIndicator.textContent = "";
                sendButton.disabled = currentLength === 0;
            }
        }

        function clearEditor() {
            quill.root.innerHTML = '<p class="ql-align-center"><br></p>';
            updateCharacterCount();
        }

        function clearDisplay() {
            var videoControls = document.getElementById("videoControls");
            var statusIndicator = document.getElementById("statusIndicator");

            socket.emit("clear_display");

            // Hide video controls when display is cleared
            videoControls.style.display = "none";
            hasUploadedSingleVideo = false;

            statusIndicator.textContent = "‚úÖ Cleared Display!";
            console.log("Cleared display event triggered");

            setTimeout(() => statusIndicator.textContent = "", 3000);
        }

    </script>
</head>

<body>
    <div class="logout-container">
        <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
    </div>

    <div class="container">
        <h1>Editor</h1>

        <div id="editor" class="text-area"></div>

        <p id="charCount" class="char-count">0 / 2000 characters</p>

        <div class="selectable-buttons">
            <button class="selectable-button btn selected">Static</button>
            <button class="selectable-button btn">Scroll</button>
        </div>

        <button id="sendTextBtn" onclick="sendText()" class="btn" disabled>Send Text</button>

        <p id="statusIndicator" class="status-indicator"></p>

        <hr>
        <div id="dragDropZone" class="drag-drop-zone">
            <div class="drag-drop-content">
                <div class="drag-drop-text">Drop Media Here<br><small>(Images or Videos only)</small></div>
            </div>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" class="file-input" multiple>
        <button onclick="uploadFiles()" class="btn upload-btn">Upload Media</button>
        <button id="clearDisplayBtn" onclick="clearDisplay()" class="btn">Clear Display</button>

        <!-- Video Controls for Remote Playback -->
        <div id="videoControls" style="display: none;">
            <button onclick="playVideo()" class="btn">‚ñ∂ Play</button>
            <button onclick="pauseVideo()" class="btn">‚è∏ Pause</button>
            <button onclick="muteVideo()" class="btn">üîá Mute</button>
            <button onclick="unmuteVideo()" class="btn">üîä Unmute</button>
        </div>
    </div>
</body>

</html>